<VirtualHost *:8008>
    ServerAdmin ${APACHE_SERVER_ADMIN}

    DocumentRoot /opt/pie/apache2/agent
    <Directory /opt/pie/apache2/agent>
        Options +ExecCGI

        <RequireAll>
            Require ip ${APACHE_ADMIN_SUBNET}
            Require not local
        </RequireAll>

        PassEnv PIE_EXP_MEMORY_SIZE PIE_RES_MEMORY_SIZE
        PassEnv APACHE_SERVER_NAME APACHE_SERVER_ADMIN APACHE_ADMIN_SUBNET APACHE_REMOTEIP_TRUSTEDPROXYLIST_URL APACHE_REMOTEIP_HEADER APACHE_LOGGING APACHE_PID_FILE
        PassEnv APACHE_CACHE_LOCK APACHE_CACHE_QUICK_HANDLER APACHE_CACHE_DEFAULT APACHE_CACHE_MIN APACHE_CACHE_MAX APACHE_CACHE_LIMIT APACHE_CACHE_IGNORE_CACHECONTROL APACHE_CACHE_IGNORE_NOLASTMOD APACHE_CACHE_IGNORE_QUERYSTRING APACHE_CACHE_STORE_EXPIRED APACHE_CACHE_STORE_NOSTORE APACHE_CACHE_STORE_PRIVATE
        PassEnv APACHE_PROXY_URL APACHE_PROXY_PRESERVE_HOST
        PassEnv PHP_FPM_HOSTNAME PHP_FPM_PORT
        PassEnv SHIBD_CONFIG_SUFFIX

        <Files ~ "^(reload|logrotate)$">
            SetHandler cgi-script
        </Files>
        <Files ping>
            SetHandler send-as-is

            Require ip ${APACHE_ADMIN_SUBNET}
            Require local
        </Files>
    </Directory>

    <IfModule mod_info.c>
        <Location /info>
            SetHandler server-info
            <RequireAll>
                Require ip ${APACHE_ADMIN_SUBNET}
                Require not local
            </RequireAll>
        </Location>
    </IfModule>

    <IfModule util_ldap.c>
        <Location /ldap-status>
            SetHandler ldap-status
            <RequireAll>
                Require ip ${APACHE_ADMIN_SUBNET}
                Require not local
            </RequireAll>
        </Location>
    </IfModule>

    <IfModule mod_status.c>
        <Location /status>
            SetHandler server-status
            Require ip ${APACHE_ADMIN_SUBNET}
            Require local
        </Location>
    </IfModule>

    <IfDefine PHP_FPM_UDS>
        # If using UDS then we've got a private PHP-FPM, so forward
        # some locations to PHP-FPM directly
        <Location ~ "^/php-fpm/(?<poolname>[a-zA-Z0-9_-]+)/ping$">
            ProxyFCGISetEnvIf true SCRIPT_NAME "%{reqenv:REQUEST_URI}"
            ProxyFCGISetEnvIf true SCRIPT_FILENAME "%{reqenv:REQUEST_URI}"
            SetHandler proxy:unix:/run/php-fpm.sock.d/%{env:MATCH_POOLNAME}.sock|fcgi://%{env:MATCH_POOLNAME}.localhost/

            Require ip ${APACHE_ADMIN_SUBNET}
            Require local
        </Location>
        <Location ~ "^/php-fpm/(?<poolname>[a-zA-Z0-9_-]+)/status$">
            ProxyFCGISetEnvIf true SCRIPT_NAME "%{reqenv:REQUEST_URI}"
            ProxyFCGISetEnvIf true SCRIPT_FILENAME "%{reqenv:REQUEST_URI}"
            SetHandler proxy:unix:/run/php-fpm.sock.d/%{env:MATCH_POOLNAME}.sock|fcgi://%{env:MATCH_POOLNAME}.localhost/

            <RequireAll>
                Require ip ${APACHE_ADMIN_SUBNET}
                Require not local
            </RequireAll>
        </Location>
    </IfDefine>
</VirtualHost>

<IfModule mod_status.c>
    # Keep track of extended status information for each request
    ExtendedStatus On

    <IfModule mod_proxy.c>
        # Show Proxy LoadBalancer status in mod_status
        ProxyStatus On
    </IfModule>
</IfModule>

# vim: syntax=apache ts=4 sw=4 sts=4 et sr noet
